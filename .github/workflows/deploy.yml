name: Hexo Auto Deploy

on:
  push:
    branches:
      - master  # ç¡®ä¿è¿™é‡Œæ˜¯ä½ å­˜æ”¾æºç çš„ä¸»åˆ†æ”¯å (master æˆ– main)

# ğŸ†• æ–°å¢ï¼šç»™äºˆæœºå™¨äººå†™æƒé™ï¼Œå¦åˆ™å®ƒæ— æ³•æ¨é€åˆ° gh-pages åˆ†æ”¯
permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: true

    # 2. å®‰è£… Node.js
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    # 3. ç¼“å­˜ä¾èµ–
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    # 4. å®‰è£…ä¾èµ–
    - name: Install dependencies
      run: npm install

    # 5. ç”Ÿæˆé™æ€æ–‡ä»¶
    - name: Build Hexo
      run: |
        npx hexo clean
        npx hexo generate

    # 6. éƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨ (ä»»åŠ¡ä¸€)
    - name: Deploy to Aliyun
      uses: easingthemes/ssh-deploy@main
      env:
        SSH_PRIVATE_KEY: ${{ secrets.HEXO_DEPLOY_PRI }}
        ARGS: "-rlgoDzvc -i"
        SOURCE: "public/"
        REMOTE_HOST: ${{ secrets.HEXO_SERVER_IP }}
        REMOTE_USER: ${{ secrets.HEXO_SERVER_USER }}
        TARGET: "/var/www/html"
        EXCLUDE: "/node_modules/"

    # 7. ğŸ†• éƒ¨ç½²åˆ° GitHub Pages (ä»»åŠ¡äºŒ)
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }} # è¿™æ˜¯ GitHub è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œæ— éœ€ä½ è‡ªå·±é…ç½® Secret
        publish_dir: ./public
        publish_branch: gh-pages  # ç½‘é¡µæ–‡ä»¶å°†å­˜æ”¾åœ¨ gh-pages åˆ†æ”¯ï¼Œä¿æŒæºç åˆ†æ”¯æ•´æ´