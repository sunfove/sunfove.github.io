import os
import requests
import datetime
import random
import json

# ================= é…ç½®åŒº =================
# åšå®¢æ–‡ç« ä¿å­˜è·¯å¾„
POSTS_DIR = 'source/_posts'

# å¦‚æœæœ¬åœ°è¿è¡Œæ²¡æœ‰ç¯å¢ƒå˜é‡ï¼Œå¯ä»¥ä¸´æ—¶å¡«åœ¨è¿™é‡Œæµ‹è¯•ï¼Œä½†æäº¤åˆ° GitHub æ—¶è®°å¾—åˆ æ‰ï¼
API_KEY = os.environ.get("LLM_API_KEY")
BASE_URL = os.environ.get("LLM_BASE_URL", "https://api.deepseek.com")


# =========================================

def get_daily_english():
    """è·å–é‡‘å±±è¯éœ¸æ¯æ—¥ä¸€å¥ (ä½œä¸ºè½»æ¾çš„å¼€å¤´)"""
    try:
        url = "http://open.iciba.com/dsapi/"
        res = requests.get(url, timeout=5).json()
        return res['content'], res['note'], res['picture2']
    except:
        return "Light is the shadow of God.", "å…‰æ˜¯ä¸Šå¸çš„å½±å­ã€‚", ""


def generate_physics_problem():
    """è°ƒç”¨ LLM ç”Ÿæˆç¡¬æ ¸ç‰©ç†/æ•°å­¦é¢˜"""
    if not API_KEY:
        return None, None

    # å†³å®šä»Šå¤©çš„è¯¾é¢˜ï¼š70% å…‰å­¦, 20% å¾®ç§¯åˆ†, 10% æ¦‚ç‡è®º
    topics = ["Optics (Physics)"] * 7 + ["Calculus"] * 2 + ["Probability Theory"] * 1
    today_topic = random.choice(topics)

    # æ„é€  Prompt (æç¤ºè¯)
    system_prompt = "You are a rigorous physics and mathematics professor. You specialize in Optics."
    user_prompt = f"""
    Please generate a **thought-provoking problem** for me to solve today.

    **Requirements:**
    1. Subject: **{today_topic}**.
    2. Language: **English**.
    3. Content: The problem should be conceptual or calculation-based. It should be interesting and non-trivial.
    4. Format: 
       - First, present the **Problem** clearly.
       - Then, provide a detailed **Solution** and **Explanation**.

    **Output Format (JSON):**
    {{
        "topic": "{today_topic}",
        "question": "The question content...",
        "answer": "The detailed solution..."
    }}
    """

    headers = {
        "Authorization": f"Bearer {API_KEY}",
        "Content-Type": "application/json"
    }

    data = {
        "model": "deepseek-chat",  # æˆ–è€… "gpt-3.5-turbo"
        "messages": [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt}
        ],
        "response_format": {"type": "json_object"}  # å¼ºåˆ¶ JSON æ ¼å¼ï¼Œæ–¹ä¾¿è§£æ
    }

    try:
        response = requests.post(f"{BASE_URL}/chat/completions", headers=headers, json=data, timeout=30)
        result = response.json()
        content_str = result['choices'][0]['message']['content']
        content_json = json.loads(content_str)
        return content_json['topic'], content_json['question'], content_json['answer']
    except Exception as e:
        print(f"AI Generation Failed: {e}")
        # å¤‡ç”¨ï¼šå¦‚æœ AI æŒ‚äº†ï¼Œè¿”å›ä¸€ä¸ªé™æ€çš„å…œåº•é—®é¢˜
        return "Optics", "Why is the sky blue?", "Rayleigh scattering..."


def create_markdown():
    today = datetime.date.today()
    date_str = today.strftime("%Y-%m-%d")

    # 1. è·å–å†…å®¹
    en_content, en_note, en_img = get_daily_english()
    topic, question, answer = generate_physics_problem()

    if not topic:
        print("No API Key found or generation failed. Skipping.")
        return

    # 2. ç”Ÿæˆ Markdown
    # æ³¨æ„ï¼šä½¿ç”¨äº† Hexo çš„ {% fold %} æ ‡ç­¾æ¥æŠ˜å ç­”æ¡ˆï¼Œé˜²æ­¢ä¸€çœ¼çœ‹åˆ°ç»“æœ
    md_content = f"""---
title: "ğŸ§  Daily Physics: {topic} | {date_str}"
date: {datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")}
categories: ç¡¬æ ¸æ—¥æŠ¥
tags: [Physics, {topic}, English]
---

## â˜• Morning English
![]({en_img})
> **{en_content}**
> *{en_note}*

---

## âš›ï¸ Today's Challenge: {topic}

### â“ Problem
{question}

---

### ğŸ’¡ Solution & Analysis
<details>
<summary style="cursor: pointer; color: #2c3e50; font-weight: bold;">Click to reveal the solution</summary>

{answer}

</details>

---

*(Generated by AI Professor via GitHub Actions)*
"""

    # 3. å†™å…¥æ–‡ä»¶
    filename = f"{date_str}-physics.md"
    filepath = os.path.join(POSTS_DIR, filename)

    if not os.path.exists(filepath):
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(md_content)
        print(f"Successfully generated: {filename}")
    else:
        print("File already exists.")


if __name__ == "__main__":
    create_markdown()